#!/bin/bash

set -e

unameOut="$(uname -s)"
case "${unameOut}" in
    Linux*)     machine=linux;;
    Darwin*)    machine=macos;;
    *)          machine="UNKNOWN:${unameOut}"
esac

SCRIPT_DIR=$( cd "$( dirname "$0" )" && pwd -P )

FLOW=$( cd "$( dirname "$SCRIPT_DIR" )" && pwd -P )
JAVAGEN=$FLOW/javagen
TMP_FILE=$JAVAGEN/temp_java_files.txt
BUILD_DIR=$FLOW/platforms/java/build
LIB=$FLOW/platforms/java/lib
LIBS=`find $LIB -name *.jar | tr '\n' ':'`$LIB/java-websocket-1.5.1/*
PATH_TO_FX=$LIB/javafx-sdk-17.0.12/$machine/lib

# Compile the runtime
pushd "$FLOW/platforms/java"
javac -d build --module-path $PATH_TO_FX --add-modules javafx.controls,javafx.fxml,javafx.base,javafx.graphics -classpath "$LIBS" -g com/area9innovation/flow/*.java javafx/com/area9innovation/flow/javafx/*.java
popd

rm -f -r $JAVAGEN
flowc1 java-sub-host=RenderSupport=com.area9innovation.flow.javafx.FxRenderSupport,FlowRuntime=com.area9innovation.flow.javafx.FxFlowRuntime file="$@" java=$JAVAGEN
find $JAVAGEN -iname '*.java' > $TMP_FILE

# Compile the generated code
javac -d $JAVAGEN/build -Xlint:unchecked --module-path $PATH_TO_FX --add-modules javafx.controls,javafx.fxml,javafx.base,javafx.graphics -encoding UTF-8 -cp "$BUILD_DIR" @$TMP_FILE

# Remove redundant files list
rm $TMP_FILE

JAVA_MAIN=$( echo "$@" | sed -e 's/.flow//g' -e 's/\//./g' )
JAVA_CLASS=$( echo $JAVA_MAIN | sed 's/.*\.//g' )

# Run the program!
java --module-path $PATH_TO_FX --add-modules javafx.controls,javafx.fxml,javafx.base,javafx.graphics -cp "$LIBS":"$BUILD_DIR":$JAVAGEN/build com.area9innovation.flow.javafx.FxLoader --flowapp="$JAVA_MAIN.$JAVA_CLASS"
