import ds/tree;
import algorithms;
import tools/flowc/backends/wise/flow_wise_types;
import tools/flowc/incremental/fitype;

export {
	makeStringType() -> FlowWiType; // string = array of chars
	fiType2FlowWiType(type : FiType, getStruct : (string) -> Maybe<[FiType]>) -> FlowWiType;
	wiType2string(type : FlowWiType) -> string;
}

makeStringType() -> FlowWiType {
	FlowWiBasictype("string");
}

fiType2FlowWiType(type : FiType, getStruct : (string) -> Maybe<[FiType]>) -> FlowWiType {
	makeDefType = \-> {
		println("TODO Type: " + toString(type));
		FlowWiBasictype("auto");
	}
	switch (type : FiType) {
		FiTypeArray(t) : FlowWiArrayType(fiType2FlowWiType(t, getStruct));
		FiTypeFunction(args, returnType) : FlowWiFntype(
			map(args, \arg -> fiType2FlowWiType(arg.type, getStruct)),
			fiType2FlowWiType(returnType, getStruct)
		);
		FiTypeRef(t) : makeDefType();
		FiTypeParameter(n) : FlowWiBasictype(n);
		FiTypeBool() : FlowWiBasictype("auto");
		FiTypeInt() : FlowWiBasictype("i32");
		FiTypeDouble() : FlowWiBasictype("f64");
		FiTypeString() : FlowWiArrayType(makeStringType());
		FiTypeFlow() : makeDefType();
		FiTypeVoid() :  FlowWiBasictype("auto");
		FiTypeNative() : makeDefType();
		FiTypeName(name, typeparameters) : FlowWiTupletype(eitherFn(
			getStruct(name),
			\args -> map(args, \a -> fiType2FlowWiType(a, getStruct)),
			\-> map(typeparameters, \t -> fiType2FlowWiType(t, getStruct))
		), name);
	}
}

wiType2string(type : FlowWiType) -> string {
	switch (type : FlowWiType) {
		FlowWiBasictype(s) : s; // TODO ?
		FlowWiFntype(types, returnType) : "(" + strGlue(map(types, wiType2string), ", ") + ") -> " + wiType2string(returnType);
		// FlowWiTupletype(__, __) : "i32"; // pointer 
		FlowWiTupletype(types, __) : "(" + strGlue(map(types, wiType2string), ", ") + ")";
		FlowWiArrayType(t) : "i32"; // pointer
	}

}