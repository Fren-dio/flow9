import tools/dsl/wase/parse;
import tools/dsl/wase/type;
import tools/dsl/wase/compile;

// Test that evaluation of this testcase gives the expected program
testWase(testname : string, testcase : string, expected : string) -> void {
	program = parseWase(testname, testcase);

	typed = typeWase(program);
	println("Compiling");

	wase = dsl2wase(typed);

	got = prettyDsl(program);
	if (expected != got) {
		println(testname + " FAILED. Expected: ");
		println(expected);
		// println("Got after parse:");
		// println(got);
		println("Typed:");
		println(prettyDsl(typed));
		println("As wase:");
		println(wase);
	}
}

main() {
	// Shows that recursion of dynamic code does not work well at compile time
	testWase("wase 1",
		<< 
			export foo : mutable f64 = 42.1;

			bar(n : auto) -> auto {
				foo + n + 1.0;
			}
			// table calls : (i32) -> i32 = [1, 2];
//			calls : table<(i32) -> i32> = [1, 2];
		>>,
		<< >>
	);

	quit(0);
}
