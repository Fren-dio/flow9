import tools/dsl/wase/parse;
import tools/dsl/wase/type;
import tools/dsl/wase/compile;
import tools/dsl/wase/pretty_wase;
import formats/wasm/wasm_encode;

// Test that evaluation of this testcase gives the expected program
compileWase2File(filename : string, testcase : string, onDone : () -> void) -> void {
	program = parseWase(filename, testcase);

	typed = typeWase(program);
	println("Compiling " + filename);
	wase = dsl2wase(typed);

	got = prettyDsl(program);
	if (true) {
		// println("Typed:");
		// println(prettyDsl(typed));
		println("As wase:");
		println(prettyWase(wase));
	}

	wasm = wase2wasm(wase);
	println(wasm);
	bytes = wasmModule2bytes(wasm);
	
	setFileContentBytes(filename + ".wasm", 
		fold(bytes, "", \acc, byte -> {
			acc + fromCharCode(byte)
		})
	);

	startProcess("wasm2wat", [filename + ".wasm", "-o", filename + ".wat"], ".", "", \ec, so, se -> {
		println(ec);
		println(so);
		println(se);
		onDone();
	});
}

main() {
	compileWase2File("wase1",
		<< 

			main() -> () {
				1 | 2 & 3 ^ 2;
				1;
				{}
			}

		>>,
		\ -> {
			quit(0);
		}
	);
}
