import fabric/fabric;

export {
	fabricUndo(name : string) -> Fabric;
}

fabricUndo(valueName : string) -> Fabric {
	undoStack = valueName + "Undo";
	undoEnabled = valueName + "undoenabled";
	redoStack = valueName + "Redo";
	redoEnabled = valueName + "redoenabled";
	currentBuffer = valueName + "undocurrent";
	working = valueName + "undoworking";

	magic = 40000337; // We use this as a special marker to indicate that the value has not been set yet

	BLetMany([
			flow(currentBuffer), magic, 
			undoStack, [], 
			redoStack, [], 
			undoEnabled, false, 
			redoEnabled, false, 
			working, false
		],
		BGetEnv(\benv -> {
			BGroup([
				BSelect1(valueName, \env, value -> {
					if (!getFab(env, working, false)) {
						currentValue = getFab(env, currentBuffer, magic);
						newValue = getFab(env, valueName, magic);

						if (currentValue == magic) {
							setFab(env, currentBuffer, newValue);
						} else if (currentValue != newValue) {
							stack = getFab(env, undoStack, []);
							setFab(env, undoStack, concat([currentValue], stack));
							setFab(env, redoStack, []);
							setFab(env, currentBuffer, newValue);
							setFab(env, undoEnabled, true);
							setFab(env, redoEnabled, false);
						}
					}
					BEmpty();
				}),

				BCols([
					BIconButton("undo", \env -> {
						values = getFab(env, undoStack, []);
						if (length(values) > 0) {
							setFab(env, working, true);
							currentValue = getFab(env, currentBuffer, magic);
							setFab(env, redoStack, concat([currentValue], getFab(env, redoStack, [])));
							setFab(env, currentBuffer, values[0]);
							setFab(env, valueName, values[0]);
							setFab(env, undoStack, tail(values));
							setFab(env, working, false);
							setFab(env, undoEnabled, length(values) > 1);
							setFab(env, redoEnabled, true);
						}
					}, [], [MEnabled(getFabDyn(benv, undoEnabled, true))]),
					BIconButton("redo", \env -> {
						redoValues = getFab(env, redoStack, []);
						if (length(redoValues) > 0) {
							setFab(env, working, true);
							currentValue = getFab(env, currentBuffer, magic);
							setFab(env, undoStack, concat([currentValue], getFab(env, undoStack, [])));
							setFab(env, currentBuffer, redoValues[0]);
							setFab(env, valueName, redoValues[0]);
							setFab(env, redoStack, tail(redoValues));
							setFab(env, working, false);
							setFab(env, redoEnabled, length(redoValues) > 1);
							setFab(env, undoEnabled, true);
						}
					}, [], [MEnabled(getFabDyn(benv, redoEnabled, true))])
				])
			])
		})
	);
}



/*
export function clipboard(valueName: string): Fabric {
	const currentBuffer = valueName + "Clipboard";
	const cutVisible = valueName + "cutvisible";
	const cutEnabled = valueName + "cutenabled";
	const copyEnabled = valueName + "copyenabled";

	return define(currentBuffer, null,
		define(cutVisible, false,
			define(cutEnabled, false,
				define(copyEnabled, true,
					cols([
						select([valueName], (env) => {
							setValue(env, copyEnabled, true);
							const currentValue = getValue(env, valueName);
							setValue(env, cutVisible, Array.isArray(currentValue));
							setValue(env, cutEnabled, Array.isArray(currentValue) && currentValue.length > 0);
							return empty();
						}),
						select([cutVisible], (env) => {
							if (getValue(env, cutVisible)) {
								return button({ icon: "content_cut", enable: cutEnabled }, (env) => {
									const cvalue = getValue(env, valueName);
									setValue(env, currentBuffer, cvalue);
									navigator.clipboard.writeText(JSON.stringify(cvalue));
									setValue(env, valueName, []);
								});
							} else {
								return empty();
							}
						}),
						button({ icon: "content_copy", enable: copyEnabled }, (env) => {
							const cvalue = getValue(env, valueName);
							setValue(env, currentBuffer, cvalue);
							navigator.clipboard.writeText(JSON.stringify(cvalue));
							setValue(env, copyEnabled, false);
						}),
						button({ icon: "content_paste" }, (env) => {
							navigator.clipboard.readText().then(text => {
								try {
									const value = JSON.parse(text);
									setValue(env, valueName, value);
								} catch (e) {
									console.error("Failed to parse clipboard content:", e);
									setValue(env, valueName, getValue(env, currentBuffer));
								}
							});
						})
					])
				)
			)
		)
	);
}*/