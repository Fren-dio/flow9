import material/material;
import material/material_manager;
import material/material2tropic;
import material/material_dialog;
import material/material_manager;

log_msg(msg : string) -> void {
	log = "/home/dmitry/area9/flow9/resources/flow/debug.txt";
	x = if (fileExists(log)) getFileContent(log) else "";
	if (!setFileContent("/home/dmitry/area9/flow9/resources/flow/debug.txt", x + "\n" + msg)) {
		println("CRASH");
		quit(-1);
	}
}

main() {
	manager = makeMaterialManager([]);

	text = make("INITIAL TEXT");
	focus = make(false);
	position = make(strlen("INITIAL TEXT"));

	message = make("MESSAGE");
	origin = make("ORIGIN");

	listener1 = addExtendedEventListener(getElementById("document"), "update", \args -> {
		log_msg("LISTENER1:\n" + toString(args));
		txt = cast(args[0] : flow -> string);
		next(message, txt);
		next(origin, "");
		next(text, txt);
	});
	listener1();
	listener2 = addMessageEventListener(
		\msg, orig -> {
			log_msg("LISTENER2:\n" + msg + "\n" + orig);
			next(message, msg);
			next(origin, orig);
		}
	);
	listener2();
	listener3 = addExtendedEventListener(mainRenderClip(), "message", \args -> {
		log_msg("LISTENER3:\n" + toString(args));
		txt = cast(args[0] : flow -> string);
		next(message, txt);
		next(origin, "");
		next(text, txt);
	});
	listener3();
	listener4 = addEventListener(mainRenderClip(), "message", \ -> {
		log_msg("LISTENER4");
	});
	listener4();

	mrender(manager, false,
		//MCenter(
			MLines([
				MTextInput(text, [MMaxLines(-1)], []),
				MTextButton("Add Text", \ -> /*if (getValue(focus))*/ {
					next(text, strInsert(getValue(text), "[TEXT]", getValue(position)));
					next(position, getValue(position) + strlen("[TEXT]"));
					//deferred(\ -> next(focus, true));
				}, [], []),
				MTextInput(message, [], []),
				MTextInput(origin, [], [])
			])
		//)
	);
}
